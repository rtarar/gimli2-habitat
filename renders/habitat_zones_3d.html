<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gimli2 Habitat - 3D Zone Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
        }

        #container {
            width: 100vw;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            max-width: 320px;
            z-index: 100;
            border: 1px solid #333;
        }

        #info h2 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #4CAF50;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        #info h3 {
            margin-top: 12px;
            margin-bottom: 6px;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        .zone-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 3px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .zone-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .zone-item.active {
            background: rgba(76, 175, 80, 0.3);
        }

        .zone-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .zone-name {
            flex: 1;
            font-size: 12px;
        }

        .zone-dims {
            font-size: 10px;
            color: #888;
        }

        .opening-item {
            padding: 4px 8px;
            margin: 2px 0;
            font-size: 11px;
            border-left: 3px solid;
            padding-left: 10px;
        }

        .opening-window {
            border-color: #2196F3;
        }

        .opening-door {
            border-color: #FF9800;
        }

        .opening-hatch {
            border-color: #4CAF50;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid #333;
        }

        #controls b {
            color: #4CAF50;
        }

        #mode-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #333;
            z-index: 100;
        }

        #mode-toggle button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }

        #mode-toggle button:hover {
            background: #45a049;
        }

        #mode-toggle button.active {
            background: #2E7D32;
        }

        #dimensions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid #333;
        }

        #dimensions h4 {
            color: #4CAF50;
            margin-bottom: 8px;
        }

        #dimensions .dim {
            margin: 3px 0;
        }

        #dimensions .dim span {
            color: #888;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <div id="info">
        <h2>Gimli2 Habitat Zones</h2>
        <div id="zones-list"></div>
        <h3>Openings</h3>
        <div id="openings-list"></div>
    </div>

    <div id="mode-toggle">
        <button id="btn-day" class="active">Day Mode</button>
        <button id="btn-night">Night Mode</button>
        <button id="btn-wireframe">Wireframe</button>
    </div>

    <div id="controls">
        <b>Controls:</b> Left-drag rotate | Right-drag pan | Scroll zoom | Click zone to highlight
    </div>

    <div id="dimensions">
        <h4>Habitat Interior</h4>
        <div class="dim">Length: <span>4780mm</span></div>
        <div class="dim">Width: <span>2280mm</span></div>
        <div class="dim">Height: <span>2160mm</span></div>
        <div class="dim">Floor Area: <span>10.90 m2</span></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ============================================================
        // COORDINATE SYSTEM (from habitat.yml)
        // Origin: builder_defined from STEP file
        // Units: millimeters
        // Up axis: Z (in STEP), but Three.js uses Y-up
        // We map: STEP X -> Three X, STEP Z -> Three Y, STEP Y -> Three Z
        // ============================================================

        // Habitat interior dimensions (mm) from habitat.yml
        const HABITAT = {
            length: 4780,   // Along Y axis (front to rear)
            width: 2280,    // Along X axis (driver to passenger)
            height: 2160    // Along Z axis (floor to ceiling)
        };

        // Zone definitions from zones/*.yml specs (updated 2025-01-21)
        // Coordinate system: X = width (driver=-X, passenger=+X), Y = height, Z = length (front=+Z, rear=-Z)
        const ZONES = {
            'ZONE-001': {
                name: 'Bathroom',
                color: 0x4FC3F7,
                // CORRECTED: Full width (2280mm) x 800mm deep
                // Shower on driver/entry side, toilet on passenger side below WIN-04
                bounds: { width: 2280, depth: 800, height: 2160 },
                position: { x: 0, y: 0, z: HABITAT.length / 2 - 400 },
                description: 'Full width x 800mm deep'
            },
            'ZONE-002': {
                name: 'Kitchen',
                color: 0xFFB74D,
                // Kitchen: 609mm depth (counter) x 1948mm length (along wall)
                // Position: driver-side, starts after bathroom (800mm from front)
                bounds: { width: 609, depth: 1948, height: 2160 },
                position: { x: -HABITAT.width / 2 + 304.5, y: 0, z: HABITAT.length / 2 - 800 - 974 },
                description: '609 x 1948mm, driver-side'
            },
            // ZONE-003: U-SHELL BENCH (replaces old solid garage shell)
            // U-shaped structure: rear section + driver arm + passenger arm
            // Shell depth: 509mm, height: 860mm
            // Houses water tanks and batteries
            // Center opening: 1262mm wide (2280 - 509 - 509)
            // ... existing ZONES map ...
            'ZONE-003-GARAGE-SHELL': {
                name: 'Garage Shell Tunnel',
                color: 0x546E7A,
                // Rearmost tunnel connecting the hatches
                // Full width, 600mm deep, 860mm high
                // Position: Very rear wall
                bounds: { width: 2280, depth: 600, height: 860 },
                position: { x: 0, y: 0, z: -HABITAT.length / 2 + 300 }, // Z = -2090
                description: 'Rear tunnel with hatches'
            },
            'ZONE-003-REAR': {
                name: 'U-Shell Rear Bench',
                color: 0x78909C,
                // Rear section of the U-seating
                // Sits FORWARD of the Garage Shell Tunnel
                // Depth 600mm.
                bounds: { width: 2280, depth: 600, height: 860 },
                position: { x: 0, y: 0, z: -HABITAT.length / 2 + 600 + 300 }, // Z = -1490 (Forward of tunnel)
                description: 'Rear bench (forward of garage shell)'
            },
            'ZONE-003-PASSENGER': {
                name: 'U-Shell Passenger Arm',
                color: 0x607D8B,
                // Passenger Side = Right (+X)
                bounds: { width: 600, depth: 800, height: 860 },
                position: {
                    x: HABITAT.width / 2 - 300,  // +X side (Passenger)
                    y: 0,
                    z: -HABITAT.length / 2 + 600 + 600 + 400 // -790
                },
                description: 'Passenger arm (Kitchen side)'
            },
            'ZONE-003-DRIVER': {
                name: 'U-Shell Driver Arm',
                color: 0x607D8B,
                // Driver Side = Left (-X)
                bounds: { width: 600, depth: 800, height: 860 },
                position: {
                    x: -HABITAT.width / 2 + 300,  // -X side (Driver)
                    y: 0,
                    z: -HABITAT.length / 2 + 600 + 600 + 400 // -790
                },
                description: 'Driver arm (Dinette side)'
            },
            'ZONE-004': {
                name: 'Sleeping (Bed)',
                color: 0xBA68C8,
                bounds: { width: 1500, depth: 2000, height: 260 },
                position: { x: 0, y: 860, z: -HABITAT.length / 2 + 1000 },
                positionRaised: { x: 0, y: 1900, z: -HABITAT.length / 2 + 1000 },
                description: 'Queen 1500 x 2000mm, lift bed (260mm thick)'
            },
            'ZONE-005': {
                name: 'Living / Dinette',
                color: 0x81C784,
                bounds: { width: 2280, depth: 2000, height: 1650 },
                position: { x: 0, y: 0, z: -HABITAT.length / 2 + 1000 },
                description: '2280 x 2000mm, 1650mm ceiling'
            },
            'ZONE-006': {
                name: 'Circulation',
                color: 0xFFF176,
                bounds: { width: 1062, depth: 1948, height: 2160 },
                position: { x: 0, y: 0, z: HABITAT.length / 2 - 800 - 974 },
                description: 'Corridor, 1062mm wide'
            },
            // NIGHTSTANDS
            'ZONE-007-D-NIGHTSTAND': {
                name: 'Nightstand (Driver)',
                color: 0xE1BEE7,
                bounds: { width: 300, depth: 509, height: 260 },
                position: { x: -HABITAT.width / 2 + 240, y: 860, z: -HABITAT.length / 2 + 254.5 },
                description: 'Nightstand 300x509mm (on U-shell arm)'
            },
            'ZONE-007-D-UPPER': {
                name: 'Upper Cabinet (Driver)',
                color: 0xD1C4E9,
                bounds: { width: 300, depth: 2000, height: 725 },
                position: { x: -HABITAT.width / 2 + 150, y: 1435, z: -HABITAT.length / 2 + 1000 },
                description: 'Upper cabinet (above window)'
            },
            'ZONE-007-P-NIGHTSTAND': {
                name: 'Nightstand (Pass.)',
                color: 0xE1BEE7,
                bounds: { width: 300, depth: 509, height: 260 },
                position: { x: HABITAT.width / 2 - 240, y: 860, z: -HABITAT.length / 2 + 254.5 },
                description: 'Nightstand 300x509mm (on U-shell arm)'
            },
            'ZONE-007-P-UPPER': {
                name: 'Upper Cabinet (Pass.)',
                color: 0xD1C4E9,
                bounds: { width: 300, depth: 2000, height: 725 },
                position: { x: HABITAT.width / 2 - 150, y: 1435, z: -HABITAT.length / 2 + 1000 },
                description: 'Upper cabinet (above window)'
            },
            'CABINETS': {
                name: 'Floor-to-Ceiling Cabinets',
                color: 0xA1887F,
                bounds: { width: 609, depth: 1948, height: 2160 },
                position: { x: HABITAT.width / 2 - 304.5, y: 0, z: HABITAT.length / 2 - 800 - 974 },
                description: '609 x 1948mm, passenger-side'
            }
        };

        // ============================================================
        // OPENINGS
        // ============================================================
        const OPENINGS = {
            windows: [
                {
                    id: 'WIN-01',
                    name: 'RA-40 Driver Rear',
                    wall: 'driver', // -X wall (Left)
                    cutout_width: 1063,
                    cutout_height: 670,
                    center_y: 1100,
                    center_z: -HABITAT.length / 2 + 1200
                },
                {
                    id: 'WIN-02',
                    name: 'RA-40 Passenger Rear',
                    wall: 'passenger', // +X wall (Right)
                    cutout_width: 1063,
                    cutout_height: 670,
                    center_y: 1100,
                    center_z: -HABITAT.length / 2 + 1200
                },
                {
                    id: 'WIN-04',
                    name: 'RA-30 Bathroom',
                    wall: 'driver', // -X wall (Driver Side)
                    cutout_width: 673,
                    cutout_height: 570,
                    center_y: 1400,
                    center_z: HABITAT.length / 2 - 400
                },
                {
                    id: 'WIN-05',
                    name: 'RA-40 Kitchen',
                    wall: 'passenger', // +X wall (Right)
                    cutout_width: 1063,
                    cutout_height: 670,
                    center_y: 1100,
                    center_z: HABITAT.length / 2 - 800 - 1000
                }
            ],
            doors: [
                {
                    id: 'DOOR-01',
                    name: 'Entry Door (Pass Side)',
                    wall: 'passenger', // +X wall (Right)
                    cutout_width: 700,
                    cutout_height: 1800,
                    center_y: 900,
                    center_z: HABITAT.length / 2 - 400
                }
            ],
            hatches: [
                {
                    id: 'HATCH-01',
                    name: 'Garage Hatch Driver',
                    wall: 'driver', // -X
                    cutout_width: 600,
                    cutout_height: 550,
                    center_y: 430,
                    center_z: -HABITAT.length / 2 + 500
                },
                {
                    id: 'HATCH-02',
                    name: 'Garage Hatch Passenger',
                    wall: 'passenger', // +X
                    cutout_width: 600,
                    cutout_height: 550,
                    center_y: 430,
                    center_z: -HABITAT.length / 2 + 500
                }
            ]
        };

        // ============================================================
        // SYSTEMS COMPONENTS
        // ============================================================
        const COMPONENTS = {
            'AXLE': {
                name: 'Rear Axle Line',
                color: 0xFF0000, // Bright Red
                // Visualization of the rear axle position
                bounds: { width: 3000, depth: 50, height: 50 }, // Wider than habitat to stick out
                position: {
                    x: 0,
                    y: -100, // Below floor
                    z: -250  // -2390 (Rear) + 2140 = -250
                }
            },
            'TANK-U-CUSTOM': {
                name: 'Custom U-Tank (Absolute Coords)',
                color: 0x0277BD, // Dark Blue
                // CLEARANCE ADJUSTED U-TANK
                // Coords are now ABSOLUTE (position 0,0,0) to prevent placement errors.
                // 1. Garage Tunnel Zone: [-2390, -1790]. TANK MUST BE FORWARD OF -1790.
                // 2. Rear Bench Zone: [-1790, -1190]. Tank Rear sits here.

                bounds: { width: 2280, depth: 2500, height: 400 },
                position: { x: 0, y: 0, z: 0 }, // Using absolute world coords for parts
                parts: [
                    // 1. Rear Connector
                    // Sits inside Rear Bench, flush against Garage Tunnel wall (-1790).
                    // Depth 150mm. Z Range: [-1790, -1640].
                    // Center Z: -1715.
                    // Height 380mm. Center Y: 190 (on floor).
                    { width: 2280, depth: 150, height: 380, x: 0, y: 190, z: -1715 },

                    // 2. Living Arms (Main Volume)
                    // Connect to Rear (-1640) and extend forward 800mm.
                    // Z Range: [-1640, -840].
                    // Center Z: -1240.
                    // Width 350mm. Center X +/- 965.
                    { width: 350, depth: 800, height: 380, x: -965, y: 190, z: -1240 }, // Driver
                    { width: 350, depth: 800, height: 380, x: 965, y: 190, z: -1240 },  // Passenger

                    // 3. Forward Extensions (Low Profile)
                    // Connect to Arms (-840) and extend forward 1500mm.
                    // Z Range: [-840, +660].
                    // Center Z: -90.
                    // Height 180mm. Center Y: 90 (on floor).
                    { width: 350, depth: 1500, height: 180, x: -965, y: 90, z: -90 }, // Driver Fwd
                    { width: 350, depth: 1500, height: 180, x: 965, y: 90, z: -90 }   // Pass Fwd
                ]
            },
            'ALDE': {
                name: 'Alde Heater',
                color: 0xE53935, // Red
                // Passenger Side (+X)
                bounds: { width: 420, depth: 500, height: 300 },
                position: {
                    x: HABITAT.width / 2 - 300, // +X (Passenger)
                    y: 450,
                    z: -790
                }
            },
            'ELEC': {
                name: 'Electrical Core',
                color: 0x8E24AA, // Purple
                // Driver Side (-X)
                bounds: { width: 250, depth: 500, height: 400 },
                position: {
                    x: -HABITAT.width / 2 + 300, // -X (Driver)
                    y: 650,
                    z: 800
                }
            },
            'BATTERIES': {
                name: 'Battery Bank (300kg)',
                color: 0xFFB300, // Amber
                // Driver Side (-X)
                bounds: { width: 400, depth: 600, height: 350 },
                position: {
                    x: -HABITAT.width / 2 + 304.5, // -X (Driver)
                    y: 375,
                    z: 800
                }
            },
            'PLUMBING': {
                name: 'Water Pump & Manifold',
                color: 0x00ACC1, // Cyan
                // Rear Bench - Dead space above low-profile tank connector
                bounds: { width: 400, depth: 300, height: 300 },
                position: {
                    x: 0,
                    y: 450, // Above tank (380mm)
                    z: -1715 // Above rear tank connector
                }
            },
            'DIESEL': {
                name: 'Diesel Tank (Underbody Flush)',
                color: 0x616161, // Grey
                // MOVED: Driver Side Underbody (Flush).
                // X: -890 (Tucked under floor. Edge aligned with wall).
                // Position: Ends just before Rear Axle (-250).
                bounds: { width: 500, depth: 1500, height: 600 },
                position: {
                    x: -HABITAT.width / 2 + 250, // -1140 + 250 = -890. Flush.
                    y: -350,
                    z: 500
                }
            }
        };

        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 10, 50000);
        camera.position.set(4000, 3000, 5000);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.target.set(0, HABITAT.height / 2, 0);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(2000, 4000, 3000);
        scene.add(directionalLight);

        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-2000, 2000, -2000);
        scene.add(fillLight);

        // Create habitat shell (wireframe)
        const shellGeometry = new THREE.BoxGeometry(HABITAT.width, HABITAT.height, HABITAT.length);
        const shellMaterial = new THREE.MeshBasicMaterial({
            color: 0x444444,
            wireframe: true,
            transparent: true,
            opacity: 0.5
        });
        const shell = new THREE.Mesh(shellGeometry, shellMaterial);
        shell.position.y = HABITAT.height / 2;
        scene.add(shell);

        // Floor
        const floorGeometry = new THREE.PlaneGeometry(HABITAT.width, HABITAT.length);
        const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x333333, side: THREE.DoubleSide });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = 1;
        scene.add(floor);

        // Zone meshes
        const zoneMeshes = {};
        let isDayMode = true;
        let isWireframe = false;

        function createZoneMesh(zoneId, zone) {
            const geometry = new THREE.BoxGeometry(zone.bounds.width, zone.bounds.height, zone.bounds.depth);
            const material = new THREE.MeshLambertMaterial({
                color: zone.color,
                transparent: true,
                opacity: 0.7
            });
            const mesh = new THREE.Mesh(geometry, material);

            const pos = isDayMode && zone.positionRaised ? zone.positionRaised : zone.position;
            mesh.position.set(pos.x, pos.y + zone.bounds.height / 2, pos.z);
            mesh.userData = { zoneId, zone };

            const edges = new THREE.EdgesGeometry(geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.5, transparent: true });
            const wireframe = new THREE.LineSegments(edges, lineMaterial);
            mesh.add(wireframe);

            return mesh;
        }

        function buildZones() {
            Object.values(zoneMeshes).forEach(mesh => scene.remove(mesh));

            for (const [zoneId, zone] of Object.entries(ZONES)) {
                if (zoneId === 'ZONE-004' && isDayMode) {
                    const mesh = createZoneMesh(zoneId, zone);
                    mesh.position.y = zone.positionRaised.y + zone.bounds.height / 2;
                    mesh.material.opacity = 0.3;
                    zoneMeshes[zoneId] = mesh;
                    scene.add(mesh);
                    continue;
                }

                const mesh = createZoneMesh(zoneId, zone);
                zoneMeshes[zoneId] = mesh;
                scene.add(mesh);
            }
        }

        // ============================================================
        // CREATE OPENINGS - Fixed orientation
        // Side walls (driver/passenger): plane faces X direction
        //   - geometry: PlaneGeometry(depth_along_wall, height)
        //   - rotation: Y = PI/2 to face X direction
        // Front/rear walls: plane faces Z direction
        //   - geometry: PlaneGeometry(width, height)
        //   - no Y rotation needed
        // ============================================================
        // System Meshes
        const systemMeshes = {};

        function createSystemMesh(sysId, sys) {
            let mesh;

            if (sys.parts) {
                // Handle composite parts (like U-Tank)
                mesh = new THREE.Group();
                sys.parts.forEach(part => {
                    const geometry = new THREE.BoxGeometry(part.width, part.height, part.depth);
                    const material = new THREE.MeshLambertMaterial({
                        color: sys.color,
                        transparent: true,
                        opacity: 0.9
                    });
                    const partMesh = new THREE.Mesh(geometry, material);
                    partMesh.position.set(part.x, part.y, part.z);
                    mesh.add(partMesh);

                    // Wireframe for part
                    const edges = new THREE.EdgesGeometry(geometry);
                    const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.3, transparent: true });
                    const wireframe = new THREE.LineSegments(edges, lineMaterial);
                    partMesh.add(wireframe);
                });

                // Position the group
                mesh.position.set(sys.position.x, sys.position.y, sys.position.z);

            } else {
                // Standard single box
                const geometry = new THREE.BoxGeometry(sys.bounds.width, sys.bounds.height, sys.bounds.depth);
                const material = new THREE.MeshLambertMaterial({
                    color: sys.color,
                    transparent: true,
                    opacity: 0.9
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(sys.position.x, sys.position.y, sys.position.z);

                // Wireframe
                const edges = new THREE.EdgesGeometry(geometry);
                const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.3, transparent: true });
                const wireframe = new THREE.LineSegments(edges, lineMaterial);
                mesh.add(wireframe);
            }

            mesh.userData = { sysId, sys };
            return mesh;
        }

        function buildComponents() {
            Object.values(systemMeshes).forEach(mesh => scene.remove(mesh));

            for (const [compId, comp] of Object.entries(COMPONENTS)) {
                const mesh = createSystemMesh(compId, comp);
                systemMeshes[compId] = mesh;
                scene.add(mesh);
            }
        }

        // ============================================================
        // CREATE OPENINGS - Fixed orientation
        // Side walls (driver/passenger): plane faces X direction
        //   - geometry: PlaneGeometry(depth_along_wall, height)
        //   - rotation: Y = PI/2 to face X direction
        // Front/rear walls: plane faces Z direction
        //   - geometry: PlaneGeometry(width, height)
        //   - no Y rotation needed
        // ============================================================
        function createOpening(opening, type) {
            const color = type === 'window' ? 0x2196F3 : type === 'door' ? 0xFF9800 : 0x4CAF50;

            // For side walls: geometry is (length_along_z, height)
            // cutout_width goes along the wall, cutout_height is vertical (Y axis)
            const geometry = new THREE.PlaneGeometry(opening.cutout_width, opening.cutout_height);
            const material = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 0.6,
                side: THREE.DoubleSide
            });
            const mesh = new THREE.Mesh(geometry, material);

            // Position based on wall
            if (opening.wall === 'driver') {
                // Driver side is -X wall
                mesh.position.set(-HABITAT.width / 2, opening.center_y, opening.center_z);
                mesh.rotation.y = Math.PI / 2;  // Face X direction (rotate around Y)
            } else if (opening.wall === 'passenger') {
                // Passenger side is +X wall
                mesh.position.set(HABITAT.width / 2, opening.center_y, opening.center_z);
                mesh.rotation.y = Math.PI / 2;  // Face X direction
            } else if (opening.wall === 'front') {
                const x = opening.center_x !== undefined ? opening.center_x : 0;
                mesh.position.set(x, opening.center_y, HABITAT.length / 2);
                // No rotation, faces Z
            } else if (opening.wall === 'rear') {
                const x = opening.center_x !== undefined ? opening.center_x : 0;
                mesh.position.set(x, opening.center_y, -HABITAT.length / 2);
                // No rotation, faces Z
            }

            // Add border
            const borderGeometry = new THREE.EdgesGeometry(geometry);
            const borderMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
            const border = new THREE.LineSegments(borderGeometry, borderMaterial);
            mesh.add(border);

            return mesh;
        }

        // Create all openings
        OPENINGS.windows.forEach(w => scene.add(createOpening(w, 'window')));
        OPENINGS.doors.forEach(d => scene.add(createOpening(d, 'door')));
        OPENINGS.hatches.forEach(h => scene.add(createOpening(h, 'hatch')));

        // Build UI
        function buildUI() {
            // Add Reset Button
            if (!document.getElementById('btn-reset')) {
                const btn = document.createElement('button');
                btn.id = 'btn-reset';
                btn.textContent = 'Reset Visibility';
                btn.style.marginTop = '10px';
                btn.style.width = '100%';
                btn.onclick = resetVisibility;
                // Insert after controls or inside info? Let's put it in info header or bottom
                document.getElementById('info').appendChild(btn);
            }

            const zonesList = document.getElementById('zones-list');
            zonesList.innerHTML = '<h3>Functional Zones</h3>';

            for (const [zoneId, zone] of Object.entries(ZONES)) {
                const item = document.createElement('div');
                item.className = 'zone-item';

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.style.marginRight = '8px';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleVisibility(zoneId, 'zone', checkbox.checked);
                };

                const content = document.createElement('div');
                content.style.display = 'flex';
                content.style.alignItems = 'center';
                content.style.flex = '1';
                content.innerHTML = `
                    <div class="zone-color" style="background: #${zone.color.toString(16).padStart(6, '0')}"></div>
                    <div class="zone-name">${zone.name}</div>
                `;

                item.appendChild(checkbox);
                item.appendChild(content);
                item.onclick = () => highlightZone(zoneId);
                zonesList.appendChild(item);
            }

            // Add Systems List
            const systemsHeader = document.createElement('h3');
            systemsHeader.innerText = 'Systems Components';
            systemsHeader.style.marginTop = '15px';
            zonesList.appendChild(systemsHeader);

            for (const [compId, comp] of Object.entries(COMPONENTS)) {
                const item = document.createElement('div');
                item.className = 'zone-item';

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.style.marginRight = '8px';
                checkbox.onclick = (e) => {
                    e.stopPropagation();
                    toggleVisibility(compId, 'system', checkbox.checked);
                };

                const content = document.createElement('div');
                content.style.display = 'flex';
                content.style.alignItems = 'center';
                content.style.flex = '1';
                content.innerHTML = `
                    <div class="zone-color" style="background: #${comp.color.toString(16).padStart(6, '0')}"></div>
                    <div class="zone-name">${comp.name}</div>
                `;

                item.appendChild(checkbox);
                item.appendChild(content);
                // item.onclick = () => highlightSystem(compId); 
                zonesList.appendChild(item);
            }

            const openingsList = document.getElementById('openings-list');
            openingsList.innerHTML = '';

            OPENINGS.windows.forEach(w => {
                const item = document.createElement('div');
                item.className = 'opening-item opening-window';
                item.textContent = `${w.id}: ${w.name} (${w.cutout_width}x${w.cutout_height}mm)`;
                openingsList.appendChild(item);
            });

            OPENINGS.doors.forEach(d => {
                const item = document.createElement('div');
                item.className = 'opening-item opening-door';
                item.textContent = `${d.id}: ${d.name} (${d.cutout_width}x${d.cutout_height}mm)`;
                openingsList.appendChild(item);
            });

            OPENINGS.hatches.forEach(h => {
                const item = document.createElement('div');
                item.className = 'opening-item opening-hatch';
                item.textContent = `${h.id}: ${h.name} (${h.cutout_width}x${h.cutout_height}mm)`;
                openingsList.appendChild(item);
            });
        }

        function toggleVisibility(id, type, isVisible) {
            if (type === 'zone' && zoneMeshes[id]) {
                zoneMeshes[id].visible = isVisible;
            } else if (type === 'system' && systemMeshes[id]) {
                systemMeshes[id].visible = isVisible;
            }
        }

        function resetVisibility() {
            // Reset Javascript State
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);

            // Reset Zones
            Object.values(zoneMeshes).forEach(mesh => mesh.visible = true);

            // Reset Systems
            Object.values(systemMeshes).forEach(mesh => mesh.visible = true);

            // Clear Highlights
            Object.values(zoneMeshes).forEach(mesh => {
                mesh.material.opacity = isWireframe ? 1.0 : 0.7;
                mesh.material.emissive = new THREE.Color(0x000000);
            });
            document.querySelectorAll('.zone-item').forEach(el => el.classList.remove('active'));
        }

        function highlightZone(zoneId) {
            Object.values(zoneMeshes).forEach(mesh => {
                mesh.material.opacity = 0.7;
                mesh.material.emissive = new THREE.Color(0x000000);
            });

            if (zoneMeshes[zoneId]) {
                zoneMeshes[zoneId].material.opacity = 1.0;
                zoneMeshes[zoneId].material.emissive = new THREE.Color(0x222222);
            }

            document.querySelectorAll('.zone-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.zone-item')?.classList.add('active');
        }

        // Mode toggles
        document.getElementById('btn-day').onclick = () => {
            isDayMode = true;
            document.getElementById('btn-day').classList.add('active');
            document.getElementById('btn-night').classList.remove('active');
            buildZones();
        };

        document.getElementById('btn-night').onclick = () => {
            isDayMode = false;
            document.getElementById('btn-day').classList.remove('active');
            document.getElementById('btn-night').classList.add('active');
            buildZones();
        };

        document.getElementById('btn-wireframe').onclick = () => {
            isWireframe = !isWireframe;
            document.getElementById('btn-wireframe').classList.toggle('active');
            Object.values(zoneMeshes).forEach(mesh => {
                mesh.material.wireframe = isWireframe;
                mesh.material.opacity = isWireframe ? 1.0 : 0.7;
            });
        };

        // Grid helper
        const gridHelper = new THREE.GridHelper(6000, 30, 0x444444, 0x333333);
        gridHelper.position.y = 0;
        scene.add(gridHelper);

        // Axes helper (X=red/width, Y=green/height, Z=blue/length)
        const axesHelper = new THREE.AxesHelper(1000);
        axesHelper.position.set(-HABITAT.width / 2 - 200, 0, HABITAT.length / 2 + 200);
        scene.add(axesHelper);

        // Initialize
        buildZones();
        buildComponents();
        buildUI();

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Raycaster for click detection
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const meshArray = Object.values(zoneMeshes);
            const intersects = raycaster.intersectObjects(meshArray);

            if (intersects.length > 0) {
                const zoneId = intersects[0].object.userData.zoneId;
                highlightZone(zoneId);
            }
        });
    </script>
</body>

</html>